#!/usr/bin/perl


use lib "/usr/local/hdb/lib";


use strict;
use warnings;
use Rsync;
use JSON;
use Env qw(HOME);


my $cfg_file = "";
my $help = 0;

my $getopt = GetOptions( "cfg=s" => \$cfg_file, "help" => \$help );

if ( ! $getopt ) {
	die("Unable to parse command line options\n");
}


if ( $help ) {
	print <<EOHELP;

hdb [--cfg=<configuration file>]

--cfg=<config file>    Specify a config file.  Default is '~/.hdbrc'.

EOHELP
}


if ( ! $cfg_file ) {
	$cfg_file = $HOME . "/.hdbrc";
}

if ( ! -s $cfg_file ) {
	die ("Config file '$cfg_file' empty or missing\n");
}


unless( open($fh, "<", $cfg_file) ) die("Unable to open config file '$cfg_file'\n");
my @config = <$fh>;
close ($fh);
$config = JSON::decode_json( join("", @config) );


@jobs = $config->{"jobs"};

exit;




my $backup = new Rsync ( { "destdir" => "/mnt/backups", "desthost" => "zaphod", "logfile" => "logs/Eddie" } );


$backup->setoption ("rsync_opts", "--exclude /dev/fd --exclude /. --exclude /..", 1);


my @sources = (		"/.[a-zA-Z0-9]*",
					"/Applications",
					"/Library",
					"/System",
					"/Users",
					"/bin",
					"/cores",
					"/dev",
					"/etc",
					"/home",
					"/mach_kernel",
					"/net",
					"/private",
					"/sbin",
					"/tmp",
					"/usr",
					"/var"
);


map { 
	$backup->go ( [$_] , "root\@zaphod:/mnt/backups/hosts/Eddie-10.6/Internal/" );
} @sources;



$backup->cleanup ();
